generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum LeadStage {
  NEW
  CONTACTED
  PREQUAL
  DOCS_REQUESTED
  DOCS_RECEIVED
  PACKAGED
  SUBMITTED
  APPROVED
  FUNDED
  LOST
}

enum LeadType {
  PURCHASE
  REFINANCE
  OTHER
}

enum SourceType {
  BANK
  ONLINE
  SELF_SOURCE
  OTHER
}

enum ApplicationStatus {
  NOT_STARTED
  IN_PROGRESS
  CONDITIONAL_APPROVED
  APPROVED
}

model Lead {
  id           String     @id @default(cuid())
  firstName    String
  lastName     String
  email        String?
  phone        String?
  sourceType   SourceType @default(OTHER)
  referrerId   String?
  referrer     Referrer?  @relation(fields: [referrerId], references: [id])
  tags         String     @default("[]") // JSON array as string
  stage             LeadStage        @default(NEW)
  leadType          LeadType         @default(PURCHASE)
  applicationStatus ApplicationStatus @default(NOT_STARTED)
  nextActionAt      DateTime?

  // Financial Information
  propertyValue        Float?
  downPayment         Float?
  loanAmount          Float?
  interestRate        Float?
  termYears           Int?      @default(25)
  monthlyIncome       Float?
  monthlyDebts        Float?
  creditScore         Int?
  gdsRatio           Float?
  tdsRatio           Float?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  tasks        Task[]
  notes        Note[]
  emails       EmailMessage[]
  checklists   Checklist[]
  documents    Document[]

  @@index([stage, nextActionAt])
  @@index([email])
  @@index([phone])
}

enum TaskStatus {
  OPEN
  DONE
  CANCELED
}

enum TaskType {
  CALL
  EMAIL
  DOCS_CHASE
  OTHER
}

model Task {
  id        String    @id @default(cuid())
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  title     String
  type      TaskType  @default(OTHER)
  dueAt     DateTime?
  status    TaskStatus @default(OPEN)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([leadId, status, dueAt])
}

model Note {
  id        String   @id @default(cuid())
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  body      String
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([leadId, createdAt])
}

enum EmailStatus {
  QUEUED
  SENT
  FAILED
}

model EmailMessage {
  id        String      @id @default(cuid())
  lead      Lead        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  to        String
  subject   String
  body      String
  status    EmailStatus @default(QUEUED)
  sentAt    DateTime?
  createdAt DateTime    @default(now())

  @@index([leadId, createdAt])
}

model ChecklistTemplate {
  id        String @id @default(cuid())
  name      String
  leadType  LeadType // Link to application type
  items     ChecklistItemTemplate[]
  createdAt DateTime @default(now())
}

model ChecklistItemTemplate {
  id          String             @id @default(cuid())
  template    ChecklistTemplate  @relation(fields: [templateId], references: [id])
  templateId  String
  label       String
  required    Boolean @default(true)
  sortOrder   Int     @default(0)
}

enum ChecklistStatus {
  OPEN
  IN_PROGRESS
  COMPLETE
}

enum ChecklistItemStatus {
  PENDING
  RECEIVED
  WAIVED
}

model Checklist {
  id        String          @id @default(cuid())
  lead      Lead            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  title     String
  status    ChecklistStatus @default(OPEN)
  items     ChecklistItem[]
  createdAt DateTime        @default(now())
}

model ChecklistItem {
  id         String              @id @default(cuid())
  checklist  Checklist           @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  checklistId String
  label      String
  required   Boolean             @default(true)
  status     ChecklistItemStatus @default(PENDING)
  file       FileObject?         @relation(fields: [fileId], references: [id])
  fileId     String?             @unique
  sortOrder  Int                 @default(0)
}

model Document {
  id        String    @id @default(cuid())
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
  kind      String
  status    String    @default("pending")
  file      FileObject? @relation(fields: [fileId], references: [id])
  fileId    String?    @unique
  createdAt DateTime  @default(now())
}

model Referrer {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations to leads
  leads     Lead[]
}

model FileObject {
  id        String   @id @default(cuid())
  url       String
  key       String?
  size      Int?
  sha256    String?
  createdAt DateTime @default(now())

  checklistItem ChecklistItem?
  document      Document?
}
